/*! Fluent Globe - v0.1.0 - 2014
* http://fluentglobe.com
* Copyright (c) 2014 Henrik Vendelbo; Licensed  */
angular.module("toggle-switch",["ng"]).directive("toggleSwitch",function(){return{restrict:"EA",replace:!0,scope:{model:"=",disabled:"@",onLabel:"@",offLabel:"@",knobLabel:"@"},template:'<div class="switch" ng-class="{ \'disabled\': disabled }"><div class="switch-animate" ng-class="{\'switch-off\': !model, \'switch-on\': model}"><span class="switch-left" ng-bind="onLabel"></span><span class="knob" ng-bind="knobLabel"></span><span class="switch-right" ng-bind="offLabel"></span></div></div>',link:function(a,b,c){c.onLabel||(c.onLabel="On"),c.offLabel||(c.offLabel="Off"),c.knobLabel||(c.knobLabel="Â "),c.disabled||(c.disabled=!1),b.on("click",function(){a.$apply(a.toggle)}),a.toggle=function(){a.disabled||(a.model=!a.model)}}}});var ReadAlong={text_element:null,audio_element:null,autofocus_current_word:!0,words:[],init:function(a){var b;for(b in a)this[b]=a[b];this.generateWordList(),this.addEventListeners(),this.selectCurrentWord()},generateWordList:function(){var a=this.text_element.querySelectorAll("[data-begin]");this.words=Array.prototype.map.call(a,function(a,b){var c={begin:parseFloat(a.dataset.begin),dur:parseFloat(a.dataset.dur),element:a};return a.tabIndex=0,c.index=b,c.end=c.begin+c.dur,a.dataset.index=c.index,c})},getCurrentWord:function(){var a,b,c,d=null;for(a=0,b=this.words.length;b>a;a+=1)if(c=this.audio_element.currentTime>=this.words[a].begin&&this.audio_element.currentTime<this.words[a].end||this.audio_element.currentTime<this.words[a].begin){d=this.words[a];break}if(!d)throw Error("Unable to find current word and we should always be able to.");return d},_current_end_select_timeout_id:null,_current_next_select_timeout_id:null,selectCurrentWord:function(){var a=this,b=this.getCurrentWord(),c=!this.audio_element.paused;if(b.element.classList.contains("speaking")||(this.removeWordSelection(),b.element.classList.add("speaking"),this.autofocus_current_word&&b.element.focus()),c){var d=b.end-this.audio_element.currentTime;"number"!=typeof this.audio_element||isNaN(this.audio_element)||(d*=1/this.audio_element.playbackRate),clearTimeout(this._current_end_select_timeout_id),this._current_end_select_timeout_id=setTimeout(function(){a.audio_element.paused||b.element.classList.remove("speaking")},Math.max(1e3*d,0));var e=this.words[b.index+1];if(e){var f=e.begin-this.audio_element.currentTime;"number"!=typeof this.audio_element||isNaN(this.audio_element)||(f*=1/this.audio_element.playbackRate),clearTimeout(this._current_next_select_timeout_id),this._current_next_select_timeout_id=setTimeout(function(){a.selectCurrentWord()},Math.max(1e3*f,0))}}},removeWordSelection:function(){var a=this.text_element.querySelectorAll("span[data-begin].speaking");Array.prototype.forEach.call(a,function(a){a.classList.remove("speaking")})},addEventListeners:function(){function a(a){if(a.target.dataset.begin){a.preventDefault();var c=a.target.dataset.index;b.audio_element.currentTime=b.words[c].begin+.01,b.selectCurrentWord()}}var b=this;b.audio_element.addEventListener("play",function(){b.selectCurrentWord(),b.text_element.classList.add("speaking")},!1),b.audio_element.addEventListener("pause",function(){b.selectCurrentWord(),b.text_element.classList.remove("speaking")},!1),b.text_element.addEventListener("click",a,!1),b.text_element.addEventListener("keypress",function(b){13===(b.charCode||b.keyCode)&&a.call(this,b)},!1),document.addEventListener("keypress",function(a){32===(a.charCode||a.keyCode)&&(a.preventDefault(),b.audio_element.paused?b.audio_element.play():b.audio_element.pause())},!1),b.text_element.addEventListener("dblclick",function(a){a.preventDefault(),b.audio_element.play()},!1),b.audio_element.addEventListener("seeked",function(){b.selectCurrentWord();var a=this;if(!a.paused){var c=a.currentTime;setTimeout(function(){a.paused||c!==a.currentTime||(a.currentTime+=.01)},500)}},!1),b.audio_element.addEventListener("ratechange",function(){b.selectCurrentWord()},!1)}};