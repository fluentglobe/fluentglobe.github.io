/*! Fluent Globe - v0.1.0 - 2015
* http://fluentglobe.com
* Copyright (c) 2015 Henrik Vendelbo; Licensed  */
(function(){var a,b,c=function(a,b){return function(){return a.apply(b,arguments)}},d={}.hasOwnProperty,e=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};a=function(){function a(a,b,e){var f,g;this.s=a,this.name=b,this._check_pending=c(this._check_pending,this),this.pending=c(this.pending,this),this.on_changes=c(this.on_changes,this),this.retrieve_changes=c(this.retrieve_changes,this),this._send_changes=c(this._send_changes,this),this._queue_change=c(this._queue_change,this),this._make_change=c(this._make_change,this),this.update=c(this.update,this),this._check_update=c(this._check_update,this),this._notify_client=c(this._notify_client,this),this._index_loaded=c(this._index_loaded,this),this.on_entity_version=c(this.on_entity_version,this),this.get_version=c(this.get_version,this),this.load_versions=c(this.load_versions,this),this.on_index_error=c(this.on_index_error,this),this.on_index_page=c(this.on_index_page,this),this._refresh_store=c(this._refresh_store,this),this.send=c(this.send,this),this.on_data=c(this.on_data,this),this.start=c(this.start,this),this._remove_entity=c(this._remove_entity,this),this._save_entity=c(this._save_entity,this),this._load_data=c(this._load_data,this),this._verify=c(this._verify,this),this._load_meta=c(this._load_meta,this),this.show_data=c(this.show_data,this),this.on=c(this.on,this),this.jd=this.s.jd,this.options=this.jd.deepCopy(this.s.options);for(b in e)d.call(e,b)&&(g=e[b],this.options[b]=g);this.chan=this.options.n,this.space=""+this.options.app_id+"/"+this.name,this.username=this.options.username,this.namespace=""+this.username+":"+this.space,this.clientid=null;try{this.clientid=localStorage.getItem(""+this.namespace+"/clientid")}catch(h){f=h,this.clientid=null}if(null==this.clientid||0!==this.clientid.indexOf("sjs")){this.clientid="sjs-"+this.s.bversion+"-"+this.uuid(5);try{localStorage.setItem(""+this.namespace+"/clientid",this.clientid)}catch(h){f=h,console.log(""+this.name+": couldnt set clientid")}}this.cb_events=["notify","notify_init","notify_version","local","get","ready","notify_pending","error"],this.cbs={},this.cb_e=this.cb_l=this.cb_ni=this.cb_np=null,this.cb_n=this.cb_nv=this.cb_r=function(){},this.initialized=!1,this.authorized=!1,this.data={last_cv:0,ccid:this.uuid(),store:{},send_queue:[],send_queue_timer:null},this.started=!1,"nostore"in this.options?(console.log(""+this.name+": not loading from localstorage"),this.loaded=0):(this._load_meta(),this.loaded=this._load_data(),console.log(""+this.name+": localstorage loaded "+this.loaded+" entities")),this._last_pending=null,this._send_backoff=15e3,this._backoff_max=12e4,this._backoff_min=15e3,console.log(""+this.namespace+": bucket created: opts: "+JSON.stringify(this.options))}return a.prototype.S4=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)},a.prototype.uuid=function(a){var b;for(a=a||8,b=this.S4();a-=1;)b+=this.S4();return b},a.prototype.now=function(){return(new Date).getTime()},a.prototype.on=function(a,b){if(!(e.call(this.cb_events,a)>=0))throw new Error("unsupported callback event");switch(this.cbs[a]=b,a){case"get":case"local":return this.cb_l=b;case"notify":return this.cb_n=b;case"notify_version":return this.cb_nv=b;case"notify_pending":return this.cb_np=b;case"notify_init":return this.cb_ni=b;case"ready":return this.cb_r=b;case"error":return this.cb_e=b}},a.prototype.show_data=function(){var a,b,c;if(this.s.supports_html5_storage()){c=0;for(b in localStorage)d.call(localStorage,b)&&(a=localStorage[b],console.log("["+b+"]: "+a),c+=1);return console.log(""+c+" total")}},a.prototype._save_meta=function(){var a;if(!this.s.supports_html5_storage())return!1;console.log(""+this.name+": save_meta ccid:"+this.data.ccid+" cv:"+this.data.last_cv);try{localStorage.setItem(""+this.namespace+"/ccid",this.data.ccid),localStorage.setItem(""+this.namespace+"/last_cv",this.data.last_cv)}catch(b){return a=b,!1}return!0},a.prototype._load_meta=function(){var a,b;if(this.s.supports_html5_storage())return this.data.ccid=localStorage.getItem(""+this.namespace+"/ccid"),null==(a=this.data).ccid&&(a.ccid=1),this.data.last_cv=localStorage.getItem(""+this.namespace+"/last_cv"),null==(b=this.data).last_cv&&(b.last_cv=0),console.log(""+this.name+": load_meta ccid:"+this.data.ccid+" cv:"+this.data.last_cv)},a.prototype._verify=function(a){return"object"in a&&"version"in a?0===this.jd.entries(a.object)?"last"in a&&this.jd.entries(a.last)>0?!0:!1:null==a.version?!1:!0:!1},a.prototype._load_data=function(){var a,b,c,d,e,f,g,h,i,j;if(this.s.supports_html5_storage()){if(h=""+this.namespace+"/e/",g=h.length,f=0,0===localStorage.length)return 0;for(c=i=0,j=localStorage.length-1;j>=0?j>=i:i>=j;c=j>=0?++i:--i)if(e=localStorage.key(c),null!=e&&e.substr(0,g)===h){d=e.substr(g,e.length-g);try{a=JSON.parse(localStorage.getItem(e))}catch(k){b=k,a=null}if(null==a)continue;this._verify(a)?(a.check=null,this.data.store[d]=a,f+=1):(console.log("ignoring CORRUPT data: "+JSON.stringify(a)),this._remove_entity(d))}return f}},a.prototype._save_entity=function(a){var b,c,d,e,f;if(!this.s.supports_html5_storage())return!1;d=""+this.namespace+"/e/"+a,f=this.data.store[a],b=JSON.stringify(f);try{localStorage.setItem(d,b)}catch(g){return c=g,!1}return e=JSON.parse(localStorage.getItem(d)),this.jd.equals(f,e)?!0:!1},a.prototype._remove_entity=function(a){var b,c;if(!this.s.supports_html5_storage())return!1;c=""+this.namespace+"/e/"+a;try{localStorage.removeItem(c)}catch(d){return b=d,!1}return!0},a.prototype.start=function(){var a,b;return console.log(""+this.space+": started initialized: "+this.initialized+" authorized: "+this.authorized),this.namespace=""+this.username+":"+this.space,this.started=!0,this.first=!1,this.authorized?this.initialized?(console.log(""+this.name+": retrieve changes from start"),this.retrieve_changes()):this.first?void 0:(this.notify_index={},this._refresh_store()):void(this.s.connected?(this.first=!0,a="limit"in this.options?"i:1:::"+this.options.limit:"i:1:::40",this.irequest_time=this.now(),this.index_request=!0,this.notify_index={},b={app_id:this.options.app_id,token:this.options.token,name:this.name,clientid:this.clientid,build:this.s.bversion},this.initialized||(b.cmd=a),this.send("init:"+JSON.stringify(b)),console.log(""+this.name+": sent init "+JSON.stringify(b)+" waiting for auth")):console.log(""+this.name+": waiting for connect"))},a.prototype.on_data=function(a){var b,c,d,e,f,g,h,i;if("auth:"!==a.substr(0,5))return"cv:?"===a.substr(0,4)?(console.log(""+this.name+": cv out of sync, refreshing index"),setTimeout(function(a){return function(){return a._refresh_store()}}(this))):"c:"===a.substr(0,2)?(b=JSON.parse(a.substr(2)),"0"!==this.data.last_cv||0!==b.length||this.cv_check||(this.cv_check=!0,this._refresh_store()),this.on_changes(b)):"i:"===a.substr(0,2)?(console.log(""+this.name+":  index msg received: "+(this.now()-this.irequest_time)),this.on_index_page(JSON.parse(a.substr(2)))):"e:"===a.substr(0,2)?(g=a.indexOf("\n"),e=a.substr(2,g-2),i=e.substr(e.lastIndexOf(".")+1),f=e.substr(0,e.lastIndexOf(".")),d=a.substr(g+1),"?"===d?this.on_entity_version(null,f,i):(c=JSON.parse(d),this.on_entity_version(c.data,f,i))):console.log("unknown message: "+a);if(h=a.substr(5),"expired"===h)console.log("auth expired"),this.started=!1,null!=this.cb_e&&this.cb_e("auth");else if(this.username=h,this.authorized=!0,this.initialized)return this.start()},a.prototype.send=function(a){return console.log("sending: "+this.chan+":"+a),this.s.send(""+this.chan+":"+a)},a.prototype._refresh_store=function(){var a;console.log(""+this.name+": _refresh_store(): loading index"),a="limit"in this.options?"i:1:::"+this.options.limit:"i:1:::40",this.send(a),this.irequest_time=this.now(),this.index_request=!0},a.prototype.on_index_page=function(a){var b,c,d,e,f,g,h,i,j;for(f=this.now(),b=f-this.irequest_time,console.log(""+this.name+": index response time: "+b),console.log(""+this.name+": on_index_page(): index page received, current= "+a.current),console.log(a),d=0,j=a.index,h=0,i=j.length;i>h;h++)c=j[h],this.notify_index[c.id]=!1,d++,setTimeout(function(a){return function(b){return function(){return a.on_entity_version(b.d,b.id,b.v)}}}(this)(c));return"mark"in a&&!("limit"in this.options)?(this.index_request=!0,console.log(""+this.name+": index last process time: "+(this.now()-f)+", page_delay: "+this.options.page_delay),e=a.mark,g=function(a){return function(b){return a.send("i:1:"+b+"::100"),a.irequest_time=a.now()}}(this),setTimeout(function(a){return function(a){return function(){return g(a)}}}(this)(e),this.options.page_delay)):(this.index_request=!1,"current"in a?(this.data.last_cv=a.current,this._save_meta()):this.data.last_cv=0,0===d?this._index_loaded():void 0)},a.prototype.on_index_error=function(){return console.log(""+this.name+": index doesnt exist or other error")},a.prototype.load_versions=function(a,b){var c,d,e,f,g;if(!(a in this.data.store))return!1;for(c=Math.max(this.data.store[a].version-(b+1),1),g=[],d=e=c,f=this.data.store[a].version-1;f>=c?f>=e:e>=f;d=f>=c?++e:--e)console.log(""+this.name+": loading version "+a+"."+d),g.push(this.send("e:"+a+"."+d));return g},a.prototype.get_version=function(a,b){var c;return c=""+a+"."+b,this.send("e:"+c)},a.prototype.on_entity_version=function(a,b,c){var e,f,g,h,i;if(console.log(""+this.name+": on_entity_version("+a+", "+b+", "+c+")"),e=null!=a?this.jd.deepCopy(a):null,g=this.initialized===!1&&null!=this.cb_ni?this.cb_ni:this.cb_n,b in this.data.store&&"last"in this.data.store[b]&&this.jd.entries(this.data.store[b].last))return e=this.jd.deepCopy(this.data.store[b].last),g(b,e,null),this.notify_index[b]=!0,this._check_update(b);if(b in this.data.store&&c<this.data.store[b].version)return this.cb_nv(b,e,c);b in this.data.store||(this.data.store[b]={}),this.data.store[b].id=b,this.data.store[b].object=a,this.data.store[b].version=parseInt(c),g(b,e,c),this.notify_index[b]=!0,h=0,i=this.notify_index;for(f in i)d.call(i,f)&&this.notify_index[f]===!1&&h++;return 0===h&&this.index_request===!1?this._index_loaded():void 0},a.prototype._index_loaded=function(){return console.log(""+this.name+": index loaded, initialized: "+this.initialized),this.initialized===!1&&(this.cb_r(),console.log(""+this.name+": intialized and ready called")),this.initialized=!0,console.log(""+this.name+": retrieve changes from index loaded"),this.retrieve_changes()},a.prototype._notify_client=function(a,b,c,d,e){var f,g,h,i,j,k,l,m,n;return console.log(""+this.name+": _notify_client("+a+", "+b+", "+c+", "+JSON.stringify(d)+")"),null==this.cb_l?(console.log(""+this.name+": no get callback, notifying without transform"),void this.cb_n(a,b,e)):(f=this.cb_l(a),n=null,m=null,g=null,l=[],"array"===this.jd.typeOf(f)&&(h=f[2],i=f[1],f=f[0],g=this.s._captureCursor(h),g&&(l[0]=g.startOffset,"endOffset"in g&&(l[1]=g.endOffset))),null!=f&&null!=c?(k=this.jd.object_diff(c,f),console.log("client/server version diff: "+JSON.stringify(k)),0===this.jd.entries(k)?(console.log("local diff 0 entries"),m=d,n=c):(console.log("o_diff"),console.log(k),console.log("orig_object"),console.log(c),console.log("c_object"),console.log(f),console.log("client modified doing transform"),m=this.jd.transform_object_diff(k,d,c),n=b),g?(j=this.jd.apply_object_diff_with_offsets(n,m,i,l),null!=h&&"value"in h&&(h.value=j[i]),g.startOffset=l[0],l.length>1&&(g.endOffset=l[1],g.startOffset>=g.endOffset&&(g.collapsed=!0)),this.s._restoreCursor(h,g)):(console.log("in regular apply_object_diff"),console.log("t_object"),console.log(n),console.log("t_diff"),console.log(m),j=this.jd.apply_object_diff(n,m)),this.cb_n(a,j,e)):b?this.cb_n(a,b,e):this.cb_n(a,null,null))},a.prototype._check_update=function(a){var b,c,d,e,f,g;if(console.log(""+this.name+": _check_update("+a+")"),!(a in this.data.store))return!1;if(d=this.data.store[a],d.change){for(c=!1,g=this.data.send_queue,e=0,f=g.length;f>e;e++)b=g[e],b.id===d.change.id&&b.ccid===d.change.ccid&&(c=!0);return c?!1:(this._queue_change(d.change),!0)}return null!=d.check?!1:"last"in d&&this.jd.equals(d.object,d.last)?(delete d.last,this._remove_entity(a),!1):(b=this._make_change(a),null!=b?(d.change=b,this._queue_change(b)):this._remove_entity(a),!0)},a.prototype.update=function(a,b){var c,d,e,f,g;if(1===arguments.length){if(null==this.cb_l)throw new Error("missing 'local' callback");b=this.cb_l(a),"array"===this.jd.typeOf(b)&&(b=b[0])}if(console.log(""+this.name+": update("+a+")"),null==a&&null==b)return!1;if(null!=a){if(0===a.length||-1!==a.indexOf("/"))return!1}else a=this.uuid();a in this.data.store||(this.data.store[a]={id:a,object:{},version:null,change:null,check:null}),d=this.data.store[a],d.last=this.jd.deepCopy(b),d.modified=this.s._time(),this._save_entity(a),g=this.data.send_queue;for(e=0,f=g.length;f>e;e++)if(c=g[e],String(a)===c.id)return console.log(""+this.name+": update("+a+") found pending change, aborting"),null;return null!=d.check&&clearTimeout(d.check),d.check=setTimeout(function(a){return function(b,c){return function(){return c.check=null,c.change=a._make_change(b),delete c.last,a._save_entity(b),a._queue_change(c.change)}}}(this)(a,d),this.options.update_delay),a},a.prototype._make_change=function(a){var b,c,d;if(d=this.data.store[a],c={id:String(a),ccid:this.uuid()},this.initialized)if(null!=this.cb_l)b=this.cb_l(a),"array"===this.jd.typeOf(b)&&(b=b[0]);else{if(!("last"in d))return null;b=d.last}else{if(!("last"in d))return null;b=d.last}return null!=d.version&&(c.sv=d.version),null===b&&null!=d.version?(c.o="-",console.log(""+this.name+": deletion requested for "+a)):null!=b&&null!=d.object?(c.o="M","sendfull"in d?(c.d=this.jd.deepCopy(b),delete d.sendfull):(c.v=this.jd.object_diff(d.object,b),0===this.jd.entries(c.v)&&(c=null))):c=null,c},a.prototype._queue_change=function(a){return null!=a?(console.log("_queue_change("+a.id+":"+a.ccid+"): sending"),this.data.send_queue.push(a),this.send("c:"+JSON.stringify(a)),this._check_pending(),null!=this.data.send_queue_timer&&clearTimeout(this.data.send_queue_timer),this.data.send_queue_timer=setTimeout(this._send_changes,this._send_backoff)):void 0},a.prototype._send_changes=function(){var a,b,c,d;if(0===this.data.send_queue.length)return console.log(""+this.name+": send_queue empty, done"),void(this.data.send_queue_timer=null);if(this.s.connected)for(d=this.data.send_queue,b=0,c=d.length;c>b;b++)a=d[b],console.log(""+this.name+": sending change: "+JSON.stringify(a)),this.send("c:"+JSON.stringify(a));else console.log(""+this.name+": _send_changes: not connected");return this._send_backoff=2*this._send_backoff,this._send_backoff>this._backoff_max&&(this._send_backoff=this._backoff_max),this.data.send_queue_timer=setTimeout(this._send_changes,this._send_backoff)},a.prototype.retrieve_changes=function(){console.log(""+this.name+": requesting changes since cv:"+this.data.last_cv),this.send("cv:"+this.data.last_cv)},a.prototype.on_changes=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x;for(c=[],m=!1,this._send_backoff=this._backoff_min,console.log(""+this.name+": on_changes(): response="),console.log(a),p=0,t=a.length;t>p;p++){for(b=a[p],d=b.id,console.log(""+this.name+": processing id="+d),l=[],x=this.data.send_queue,q=0,u=x.length;u>q;q++)k=x[q],b.clientid===this.clientid&&d===k.id&&(b.local=!0,l.push(k),c.push(d));for(r=0,v=l.length;v>r;r++)j=l[r],this.data.store[j.id].change=null,this._save_entity(j.id),this.data.send_queue=function(){var a,b,c,d;for(c=this.data.send_queue,d=[],a=0,b=c.length;b>a;a++)i=c[a],i!==j&&d.push(i);return d}.call(this);if(l.length>0&&this._check_pending(),"error"in b)switch(b.error){case 412:console.log(""+this.name+": on_changes(): empty change, dont check"),e=c.indexOf(b.id),e>-1&&c.splice(e,1);break;case 409:console.log(""+this.name+": on_changes(): duplicate change, ignoring");break;case 405:console.log(""+this.name+": on_changes(): bad version"),b.id in this.data.store&&(this.data.store[b.id].version=null),m=!0;break;case 440:console.log(""+this.name+": on_change(): bad diff, sending full object"),this.data.store[d].sendfull=!0;break;default:console.log(""+this.name+": error for last change, reloading"),b.id in this.data.store&&(this.data.store[b.id].version=null),m=!0}else g=b.o,"-"===g?(delete this.data.store[d],this._remove_entity(d),"local"in b||this._notify_client(b.id,null,null,null,null)):"M"===g?(n=this.data.store[d],"sv"in b&&null!=n&&null!=n.version&&n.version===b.sv||!("sv"in b)||1===b.ev?(null==n&&(this.data.store[d]={id:d,object:{},version:null,change:null,check:null},n=this.data.store[d]),h=this.jd.deepCopy(n.object),n.object=this.jd.apply_object_diff(n.object,b.v),n.version=b.ev,f=this.jd.deepCopy(n.object),"local"in b||this._notify_client(b.id,f,h,b.v,b.ev)):null!=n&&null!=n.version&&b.ev<=n.version?console.log(""+this.name+": old or duplicate change received, ignoring, change.ev="+b.ev+", s_data.version:"+n.version):(null!=n?console.log(""+this.name+": version mismatch couldnt apply change, change.ev:"+b.ev+", s_data.version:"+n.version):console.log(""+this.name+": version mismatch couldnt apply change, change.ev:"+b.ev+", s_data null"),null!=n&&(this.data.store[d].version=null),m=!0)):console.log(""+this.name+": no operation found for change"),m||(this.data.last_cv=b.cv,this._save_meta(),console.log(""+this.name+": checkpoint cv="+this.data.last_cv+" ccid="+this.data.ccid))}if(m)console.log(""+this.name+": reload needed, refreshing store"),setTimeout(function(a){return function(){return a._refresh_store()}}(this));else for(o=function(a){return function(b){return setTimeout(function(){return a._check_update(b)},a.options.update_delay)}}(this),s=0,w=c.length;w>s;s++)d=c[s],o(d)},a.prototype.pending=function(){var a,b,c,d,e,f;for(b=function(){var b,c,d,e;for(d=this.data.send_queue,e=[],b=0,c=d.length;c>b;b++)a=d[b],e.push(a.id);return e}.call(this),console.log(""+this.name+": pending: "+JSON.stringify(b)),e=this.data.send_queue,f=[],c=0,d=e.length;d>c;c++)a=e[c],f.push(a.id);return f},a.prototype._check_pending=function(){var a,b,c,d,e,f;if(null!=this.cb_np){if(a=this.pending(),b=!0,this._last_pending)if(b=!1,this._last_pending.length===a.length)for(f=this._last_pending,d=0,e=f.length;e>d;d++)c=f[d],-1===a.indexOf(c)&&(b=!0);else b=!0;if(b)return this._last_pending=a,this.cb_np(a)}},a}(),b=function(){function b(a,b){var e,f,g,h;if(this.app_id=a,this.options=b,this._restoreCursor=c(this._restoreCursor,this),this._captureCursor=c(this._captureCursor,this),this._sock_message=c(this._sock_message,this),this._sock_hb_check=c(this._sock_hb_check,this),this._sock_closed=c(this._sock_closed,this),this._sock_opened=c(this._sock_opened,this),this._sock_connect=c(this._sock_connect,this),this.synced=c(this.synced,this),this.send=c(this.send,this),this.stop=c(this.stop,this),this.start=c(this.start,this),this.on=c(this.on,this),this.bucket=c(this.bucket,this),this.bversion=2014030401,this.jd=new jsondiff,this.dmp=this.jd.dmp,this.auth_token=null,this.options=this.options||{},this.options.app_id=this.app_id,this.sock_opts={debug:!1},"sockjs"in this.options){h=this.options.sockjs;for(e in h)d.call(h,e)&&(g=h[e],this.sock_opts[e]=g)}"host"in this.options||(this.options.host="api.simperium.com"),"port"in this.options||(this.options.port=80),"token"in this.options&&(this.auth_token=this.options.token),f=-1!==this.options.host.indexOf("simperium.com")?"https":"http",this.buckets={},this.channels=0,"update_delay"in this.options||(this.options.update_delay=0),"page_delay"in this.options||(this.options.page_delay=0),this.options.prefix="sock/1/"+this.app_id,this.options.port=parseInt(this.options.port),80!==this.options.port&&443!==this.options.port?this.sock_url=""+f+"://"+this.options.host+":"+this.options.port+"/"+this.options.prefix:this.sock_url=""+f+"://"+this.options.host+"/"+this.options.prefix,this.stopped=!1,this._sock_backoff=3e3,this._sock_hb=1,this._sock_connect()}return b.prototype.lowerstrip=function(a){return a=a.toLowerCase(),null!=String.prototype.trim?a.trim():a.replace(/^\s+|\s+$/g,"")},b.prototype._time=function(){var a;return a=new Date,Date.UTC(a.getUTCFullYear(),a.getUTCMonth(),a.getUTCDate(),a.getUTCHours(),a.getUTCMinutes(),a.getUTCSeconds(),a.getUTCMilliseconds())/1e3},b.prototype.supports_html5_storage=function(){var a;try{return"localStorage"in window&&null!==window.localStorage}catch(b){return a=b,!1}},b.prototype.bucket=function(b,c){var d;return b=this.lowerstrip(b),c=c||{},c.n=this.channels++,d=new a(this,b,c),this.buckets[c.n]=d,d},b.prototype.on=function(a,b,c){return this.buckets[a].on(b,c)},b.prototype.start=function(){var a,b,c,e;this.stopped=!1,c=this.buckets,e=[];for(b in c)d.call(c,b)&&(a=c[b],e.push(a.start()));return e},b.prototype.stop=function(){return this.stopped=!0,null!=this.sock?this.sock.close():void 0},b.prototype.send=function(a){return this.sock.send(a)},b.prototype.synced=function(){var a,b,c;c=this.buckets;for(b in c)if(d.call(c,b)&&(a=c[b],a.pending().length>0))return!1;return!0},b.prototype._sock_connect=function(){return console.log("simperium: connecting to "+this.sock_url),this.connected=!1,this.authorized=!1,this.sock=new SockJS(this.sock_url,void 0,this.sock_opts),this.sock.onopen=this._sock_opened,this.sock.onmessage=this._sock_message,this.sock.onclose=this._sock_closed},b.prototype._sock_opened=function(){var a,b,c,e;this._sock_backoff=3e3,this.connected=!0,this._sock_hb_timer=setTimeout(this._sock_hb_check,2e4),c=this.buckets,e=[];for(b in c)d.call(c,b)&&(a=c[b],a.started?e.push(a.start()):e.push(void 0));return e},b.prototype._sock_closed=function(){var a,b,c;this.connected=!1,c=this.buckets;for(b in c)d.call(c,b)&&(a=c[b],a.authorized=!1);return console.log("simperium: sock js closed"),this._sock_backoff<4e3?this._sock_backoff=this._sock_backoff+1:this._sock_backoff=15e3,this._sock_hb_timer&&(clearTimeout(this._sock_hb_timer),this._sock_hb_timer=null),this.stopped?void 0:setTimeout(this._sock_connect,this._sock_backoff)},b.prototype._sock_hb_check=function(){var a;return a=(new Date).getTime()-this._sock_msg_time,this.connected!==!1?(a>4e4?(console.log("simperium: force conn close"),this.sock.close()):a>15e3&&(console.log("simperium: send hb "+this._sock_hb),this.sock.send("h:"+this._sock_hb)),this._sock_hb_timer=setTimeout(this._sock_hb_check,2e4)):void 0},b.prototype._sock_message=function(a){var b,c,d,e;if(this._sock_msg_time=(new Date).getTime(),c=a.data,e=c.indexOf(":"),b=null,1===e&&"h"===c.charAt(0))return void(this._sock_hb=c.substr(2));try{b=parseInt(c.substr(0,e)),c=c.substr(e+1)}catch(f){d=f,b=null}return null!==b&&b in this.buckets?this.buckets[b].on_data(c):void 0},b.prototype._captureCursor=function(a){},b.prototype._captureCursor=function(a){if("activeElement"in a&&!a.activeElement)return null;var b=this.dmp.Match_MaxBits/2,c=a.value,d={};if("selectionStart"in a){try{var e=a.selectionStart,f=a.selectionEnd}catch(g){return null}d.startPrefix=c.substring(e-b,e),d.startSuffix=c.substring(e,e+b),d.startOffset=e,d.collapsed=e==f,d.collapsed||(d.endPrefix=c.substring(f-b,f),d.endSuffix=c.substring(f,f+b),d.endOffset=f)}else{for(var h=a;h.parentNode;)h=h.parentNode;if(!h.selection||!h.selection.createRange)return null;var i=h.selection.createRange();if(i.parentElement()!=a)return null;var j=h.body.createTextRange();d.collapsed=""==i.text,j.moveToElementText(a),d.collapsed||(j.setEndPoint("EndToEnd",i),d.endPrefix=j.text,d.endOffset=d.endPrefix.length,d.endPrefix=d.endPrefix.substring(d.endPrefix.length-b)),j.setEndPoint("EndToStart",i),d.startPrefix=j.text,d.startOffset=d.startPrefix.length,d.startPrefix=d.startPrefix.substring(d.startPrefix.length-b),j.moveToElementText(a),j.setEndPoint("StartToStart",i),d.startSuffix=j.text.substring(0,b),d.collapsed||(j.setEndPoint("StartToEnd",i),d.endSuffix=j.text.substring(0,b))}return"scrollTop"in a&&(d.scrollTop=a.scrollTop/a.scrollHeight,d.scrollLeft=a.scrollLeft/a.scrollWidth),d},b.prototype._restoreCursor=function(a,b){},b.prototype._restoreCursor=function(a,b){this.dmp.Match_Distance=1e3,this.dmp.Match_Threshold=.9;var c,d,e=this.dmp.Match_MaxBits/2,f=a.value,g=b.startPrefix+b.startSuffix,h=this.dmp.match_main(f,g,b.startOffset-e);null!==h&&(c=f.substring(h,h+g.length),d=this.dmp.diff_main(g,c,!1),h+=this.dmp.diff_xIndex(d,b.startPrefix.length));var i=null;if(b.collapsed||(g=b.endPrefix+b.endSuffix,i=this.dmp.match_main(f,g,b.endOffset-e),null!==i&&(c=f.substring(i,i+g.length),d=this.dmp.diff_main(g,c,!1),i+=this.dmp.diff_xIndex(d,b.endPrefix.length))),null===h&&null!==i?h=i:null===h&&null===i&&(h=b.startOffset),null===i&&(i=h),"selectionStart"in a)a.selectionStart=h,a.selectionEnd=i;else{for(var j=a;j.parentNode;)j=j.parentNode;if(!j.selection||!j.selection.createRange)return;var k=a.value.substring(0,h),l=k.replace(/\r\n/g,"\n").length,m=j.body.createTextRange();if(m.moveToElementText(a),m.collapse(!0),m.moveStart("character",l),!b.collapsed){k=a.value.substring(h,i);var n=k.replace(/\r\n/g,"\n").length;m.moveEnd("character",n)}m.select()}"scrollTop"in b&&(a.scrollTop=b.scrollTop*a.scrollHeight,a.scrollLeft=b.scrollLeft*a.scrollWidth)},b}(),window.Simperium=b,a.prototype.on=a.prototype.on,a.prototype.start=a.prototype.start,a.prototype.load_versions=a.prototype.load_versions,a.prototype.pending=a.prototype.pending,b.prototype.on=b.prototype.on,b.prototype.start=b.prototype.start,b.prototype.bucket=b.prototype.bucket,b.prototype.synced=b.prototype.synced}).call(this);